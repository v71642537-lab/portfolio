const canvas = document.getElementById("hero-lightpass");
const context = canvas.getContext("2d");

canvas.width = 1920;
canvas.height = 1080;

const frameCount = 240;
const currentFrame = index => (
  `frames/ezgif-frame-${index.toString().padStart(3, '0')}.jpg`
);

const images = [];
const imageSeq = { frame: 0 };

// Preload images
for (let i = 1; i <= frameCount; i++) {
  const img = new Image();
  img.src = currentFrame(i);
  images.push(img);
}

window.addEventListener("scroll", () => {
  const scrollTop = html.scrollTop;
  const maxScrollTop = html.scrollHeight - window.innerHeight;
  const scrollFraction = scrollTop / maxScrollTop;
  const frameIndex = Math.min(
    frameCount - 1,
    Math.floor(scrollFraction * frameCount)
  );
  
  render(frameIndex);
});

function render(index) {
  context.clearRect(0, 0, canvas.width, canvas.height);
  context.drawImage(images[index], 0, 0);
}

// Chatbot Logic
const SYSTEM_PROMPT = `You are an assistant for Vishnu, an ECE student[cite: 1, 4]. 
Answer ONLY using this info: CGPA 8.09 [cite: 7], Skills: Python, IoT, VLSI, Embedded Systems[cite: 9, 11]. 
Projects: IoT Soil Moisture, Smart Anti-Fog Glasses, Fire Extinguishing System[cite: 15, 16, 17]. 
Location: Ramanathapuram, TN[cite: 2]. If asked anything else, say you can only discuss Vishnu's resume.`;

async function askGemini(query) {
    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=YOUR_GEMINI_API_KEY', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: SYSTEM_PROMPT + "\n\nUser Question: " + query }] }]
        })
    });
    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

document.getElementById('send-btn').addEventListener('click', async () => {
    const input = document.getElementById('user-input');
    const history = document.getElementById('chat-history');
    const userText = input.value;
    
    history.innerHTML += `<div><b>You:</b> ${userText}</div>`;
    input.value = '';
    
    const botReply = await askGemini(userText);
    history.innerHTML += `<div><b>AI:</b> ${botReply}</div>`;
    history.scrollTop = history.scrollHeight;
});

// Initial render
images[0].onload = () => render(0);
const html = document.documentElement;
